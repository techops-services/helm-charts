name: Release Charts

on:
  push:
    branches:
      - TECH-2871-improve-cicd-chartss

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
      - name: Set up Minikube
        uses: medyagh/setup-minikube@master
        with:
          minikube-version: 'latest'
          kubernetes-version: 'stable'
          driver: docker
      - name: kubectl
        run: kubectl get pods -A
      - name: Install Helm
        uses: azure/setup-helm@v3
      - name: Wait for Minikube to be ready
        run: |
          minikube status
          kubectl get nodes
          kubectl wait --for=condition=Ready node/minikube --timeout=3m

      - name: Validate Helm template
        run: |
          echo "Running Helm template validation..."
          helm template test-app charts/your-chart -f charts/your-chart/ci/test-values.yaml

      - name: Set PR status
        if: ${{ failure() }}
        run: |
          echo "::error::Helm chart validation failed. Please fix the issues before merging."
          exit 1

      - name: Perform dry-run Helm installation
        run: |
          echo "Performing dry-run Helm installation..."
          helm upgrade --install test-app charts/your-chart \
            -f charts/your-chart/ci/test-values.yaml \
            --create-namespace \
            --namespace test-namespace \
            --timeout 1m \
            --atomic \
            --dry-run

      - name: Set PR status
        if: ${{ failure() }}
        run: |
          echo "::error::Helm chart validation failed. Please fix the issues before merging."
          exit 1


      # - name: Run chart-releaser
      #   uses: helm/chart-releaser-action@v1.6.0
      #   if: success()
      #   env:
      #     CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
